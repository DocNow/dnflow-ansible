---
  - name: create a directory for logging uwsgi
    file: path=/var/log/uwsgi state=directory owner=docnow group=www-data

  - name: create configuration file
    copy: remote_src=True src=/vagrant/dnflow/dnflow.cfg.template dest=/vagrant/dnflow/dnflow.cfg

  - name: add twitter consumer key
    replace: dest=/vagrant/dnflow/dnflow.cfg regexp='YOUR_TWITTER_CONSUMER_KEY_HERE' replace={{ twitter_consumer_key }}

  - name: add twitter consumer secret
    replace: dest=/vagrant/dnflow/dnflow.cfg regexp='YOUR_TWITTER_CONSUMER_SECRET_HERE' replace={{ twitter_consumer_secret }}

  - name: add hostname 
    replace: dest=/vagrant/dnflow/dnflow.cfg regexp="HOSTNAME = 'localhost'" replace="HOSTNAME = '{{ hostname }}'"

  - name: copy luigid daemonize script
    copy: src=./docnow/files/luigid.sh dest=/vagrant/luigid.sh mode="a+x"

  - name: launch luigid
    command: "nohup /vagrant/luigid.sh"
    args:
      chdir: /vagrant

  - name: copy rq startup script
    copy: src=./docnow/files/rqworker.sh dest=/vagrant/rqworker.sh mode="a+x" 

  - name: start the rq worker
    command: "nohup /vagrant/rqworker.sh" 
    args:
      chdir: /vagrant

  - name: copy application ini file
    copy: src=./docnow/files/docnow.ini dest=/vagrant/dnflow/docnow.ini owner=docnow group=docnow

  - name: copy upstart script
    copy: src=./docnow/templates/docnow.conf dest=/etc/init/docnow.conf

  - name: db to track searches
    shell: sqlite3 db.sqlite3 < schema.sql
    args:
      chdir: /vagrant/dnflow

  - name: grant ownership to docnow user
    file: path=/vagrant/dnflow state=directory owner=docnow group=docnow recurse=yes

  - name: start application
    service: name=docnow state=started

  - name: restart webserver
    service: name=nginx state=restarted
